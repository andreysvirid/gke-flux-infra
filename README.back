# GKE + FluxCD + GitHub Actions + Helm (kbot demo)

–¶–µ–π –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –ø–æ–≤–Ω–∏–π GitOps-–ø—Ä–æ—Ü–µ—Å: —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∫–ª–∞—Å—Ç–µ—Ä—É GKE —á–µ—Ä–µ–∑ Terraform, –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è FluxCD, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è GitRepository —Ç–∞ HelmRelease –¥–ª—è PET-–ø—Ä–æ—î–∫—Ç—É kbot, –∞ —Ç–∞–∫–æ–∂ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–≥–æ –æ–±—Ä–∞–∑—É —á–µ—Ä–µ–∑ GitHub Actions.

---

## –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∫–ª–∞—Å—Ç–µ—Ä–∞ —Ç–∞ Flux —á–µ—Ä–µ–∑ Terraform


–ü–æ—Ä—è–¥–æ–∫ –¥—ñ–π:

```bash

1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é –Ω–∞ GitHub:
   https://github.com/andreysvirid/gke-flux-infra.git


2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Terraform:
 terraform init
 terraform plan -var="github_token=$GITHUB_TOKEN"
 terraform apply -var="github_token=$GITHUB_TOKEN" -auto-approve

3. HelmRelease –¥–ª—è kbot
 apiVersion: helm.toolkit.fluxcd.io/v2
 kind: HelmRelease
 metadata:
   name: kbot
   namespace: demo-helm
 spec:
   releaseName: kbot
   interval: 1m
   chart:
     spec:
       chart: ./charts/kbot2
       sourceRef:
         kind: GitRepository
         name: gke-flux-infra
         namespace: flux-system
   values:
     image:
       repository: andreysvirid/kbot2
       tag: "v1.0.0-cdc3eb0"

 git checkout develop
 git add clusters/dev/kbot-helmrelease.yaml
 git commit -m "Add HelmRelease for kbot"
 git push origin develop

4. Flux –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Å—Ç–æ—Å—É—î —Ü–µ–π HelmRelease —É –∫–ª–∞—Å—Ç–µ—Ä—ñ –ø—ñ—Å–ª—è –ø—É—à—É –∑–º—ñ–Ω —É Git.
–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Flux —É –∫–ª–∞—Å—Ç–µ—Ä—ñ
 kubectl create namespace flux-system
 flux install \
   --namespace=flux-system \
   --components=source-controller,kustomize-controller,helm-controller,notification-controller
–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Flux –¥–æ GitHub-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
 export GITHUB_USER=andreysvirid
 export GITHUB_REPO=gke-flux-infra
 export GITHUB_TOKEN=<—Ç—É—Ç_—Ç–≤—ñ–π_token>

 flux bootstrap github \
   --owner=$GITHUB_USER \
   --repository=$GITHUB_REPO \
   --branch=develop \
   --path=./clusters/dev \
   --personal
 –¶—è –∫–æ–º–∞–Ω–¥–∞: —Å—Ç–≤–æ—Ä–∏—Ç—å —É –∫–ª–∞—Å—Ç–µ—Ä—ñ –≤—Å—ñ —Ä–µ—Å—É—Ä—Å–∏ Flux, –Ω–∞–ª–∞—à—Ç—É—î GitRepository —É flux-system, –ø—ñ–¥–∫–ª—é—á–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ clusters/dev —è–∫ –¥–∂–µ—Ä–µ–ª–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ñ–≤.

–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è GitRepository
 kubectl get gitrepository -n flux-system
 kubectl describe gitrepository gke-flux-infra -n flux-system

–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
 flux get kustomizations -A
 –∞–±–æ
 flux reconcile kustomization flux-system --with-source

5. CI/CD —á–µ—Ä–µ–∑ GitHub Actions
–£ —Ä–µ–ø–æ (.github/workflows/build.yaml) –¥–æ–¥–∞—î—à –ø–∞–π–ø–ª–∞–π–Ω, —è–∫–∏–π:
–±—É–¥—É—î Docker –æ–±—Ä–∞–∑
–ø—É—à–∏—Ç—å –π–æ–≥–æ –Ω–∞ DockerHub
–æ–Ω–æ–≤–ª—é—î —Ç–µ–≥ —É values.yaml/HelmRelease
–∫–æ–º—ñ—Ç–∏—Ç—å —É develop
–ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø—É—Å–∫—É –ª–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏):
docker build -t andreysvirid/kbot2:$(git rev-parse --short HEAD) .
docker push andreysvirid/kbot2:$(git rev-parse --short HEAD)


6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ HelmRelease
kubectl get helmrelease kbot -n demo-helm -o yaml | grep -A3 "image:"
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Deployment
kubectl get deployment kbot -n demo-helm -o yaml | grep image:
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Pod
kubectl get pods -n demo-helm -l app=kbot
kubectl describe pod -n demo-helm <pod-name> | grep -i image:



7. –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏–π –∫–ª–∞—Å—Ç–µ—Ä GKE
‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π Flux
‚úÖ –ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π GitRepository —Ç–∞ HelmRelease –¥–ª—è kbot
‚úÖ –ó–º—ñ–Ω–∏ –≤ –∫–æ–¥—ñ ‚Üí GitHub Actions ‚Üí –Ω–æ–≤–∏–π Docker-–æ–±—Ä–∞–∑ ‚Üí Flux –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ —É Kubernetes üöÄ
‚ö†Ô∏è –ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á —ñ –Ω–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è.

‚úÖ –£ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ:

Terraform —Å—Ç–≤–æ—Ä—é—î GKE + FluxCD
FluxCD –ø—ñ–¥–∫–ª—é—á–∞—î —Ä–µ–ø–æ
HelmRelease —É develop –¥–µ–ø–ª–æ—ó—Ç—å kbot
GitHub Actions –æ–Ω–æ–≤–ª—é—î —Ç–µ–≥ –æ–±—Ä–∞–∑—É —ñ –ø—É—à–∏—Ç—å —É Git
Flux –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥—Ç—è–≥—É—î –Ω–æ–≤–∏–π –æ–±—Ä–∞–∑ —É –∫–ª–∞—Å—Ç–µ—Ä

